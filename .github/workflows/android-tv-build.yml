name: Android TV Build

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# WORKFLOW TRIGGERS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
on:
  push:
    branches: [main, android-tv]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build variant'
        required: true
        default: 'release'
        type: choice
        options: [release, debug, both]
      clean_build:
        description: 'Clean build (ignore cache)'
        required: false
        default: false
        type: boolean

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ENVIRONMENT VARIABLES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.jvmargs=-Xmx3g -XX:MaxMetaspaceSize=512m -Dorg.gradle.daemon=false -Dorg.gradle.caching=true -Dorg.gradle.parallel=true'

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# BUILD JOB
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
jobs:
  build-android:
    name: Build Android TV APK
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # OUTPUTS - Make artifacts available to other jobs/workflows
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      build-success: ${{ steps.build-status.outputs.success }}
    
    steps:
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 1: CHECKOUT CODE
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ฆ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper versioning

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 2: SETUP ENVIRONMENT
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: โ Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ๐ฆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ค Setup Android SDK
        uses: android-actions/setup-android@v3

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 3: CACHE MANAGEMENT
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐พ Cache Gradle dependencies
        if: github.event.inputs.clean_build != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 4: GET PROJECT VERSION
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ข Get app version
        id: get-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "๐ฑ Building version: ${VERSION}"

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 5: INSTALL DEPENDENCIES
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ Install npm dependencies
        run: |
          echo "Installing dependencies..."
          npm ci --prefer-offline --no-audit
          
      - name: ๐ง Apply patches
        run: npm run postinstall
        continue-on-error: true

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 6: CONFIGURE ANDROID BUILD
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: โ๏ธ Configure Android SDK
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          chmod +x android/gradlew

      - name: ๐ Create debug keystore
        run: |
          mkdir -p android/app
          rm -f android/app/debug.keystore
          keytool -genkeypair -v -storetype PKCS12 \
            -keystore android/app/debug.keystore \
            -storepass android -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 7: CHECK DISK SPACE
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ฝ Check disk space
        run: |
          echo "=== Disk Space Before Build ==="
          df -h
          FREE_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "๐พ Free space: ${FREE_GB}GB"
          if [ "$FREE_GB" -lt 5 ]; then
            echo "โ๏ธ  WARNING: Less than 5GB free space!"
          fi

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 8: CLEAN BUILD (IF REQUESTED)
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐งน Clean previous build
        if: github.event.inputs.clean_build == 'true'
        working-directory: android
        run: ./gradlew clean --no-daemon

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 9: BUILD RELEASE APK
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐จ Build Release APK
        id: build-release
        if: |
          github.event.inputs.build_type == 'release' || 
          github.event.inputs.build_type == 'both' || 
          github.event.inputs.build_type == ''
        working-directory: android
        run: |
          echo "๐จ Building Release APK..."
          ./gradlew assembleRelease --no-daemon --stacktrace
          echo "โ Release build completed!"
        continue-on-error: true

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 10: BUILD DEBUG APK
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐จ Build Debug APK
        id: build-debug
        if: |
          github.event.inputs.build_type == 'debug' || 
          github.event.inputs.build_type == 'both'
        working-directory: android
        run: |
          echo "๐จ Building Debug APK..."
          ./gradlew assembleDebug --no-daemon --stacktrace
          echo "โ Debug build completed!"
        continue-on-error: true

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 11: VERIFY BUILD OUTPUTS
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ Verify APK files
        id: verify-apks
        run: |
          echo "=== ๐ฆ Built APKs ==="
          
          # Check Release APKs
          if [ -d "android/app/build/outputs/apk/release" ]; then
            RELEASE_COUNT=$(find android/app/build/outputs/apk/release -name "*.apk" -type f | wc -l)
            echo "โ Release APKs: $RELEASE_COUNT"
            find android/app/build/outputs/apk/release -name "*.apk" -type f -exec ls -lh {} \;
          else
            echo "โน๏ธ  No release APKs"
          fi
          
          # Check Debug APKs
          if [ -d "android/app/build/outputs/apk/debug" ]; then
            DEBUG_COUNT=$(find android/app/build/outputs/apk/debug -name "*.apk" -type f | wc -l)
            echo "โ Debug APKs: $DEBUG_COUNT"
            find android/app/build/outputs/apk/debug -name "*.apk" -type f -exec ls -lh {} \;
          else
            echo "โน๏ธ  No debug APKs"
          fi

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 12: RENAME APKs WITH VERSION
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ท๏ธ  Rename APKs with version
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          echo "๐ Renaming APKs with version: ${VERSION}"
          
          # Rename Release APKs
          if [ -d "android/app/build/outputs/apk/release" ]; then
            for apk in android/app/build/outputs/apk/release/app-*.apk; do
              if [ -f "$apk" ]; then
                arch=$(basename "$apk" | sed 's/app-//' | sed 's/-release.apk//')
                new_name="Nuvio-TV-${VERSION}-${arch}.apk"
                mv "$apk" "android/app/build/outputs/apk/release/${new_name}"
                echo "โ Renamed to: ${new_name}"
              fi
            done
          fi
          
          # Rename Debug APKs
          if [ -d "android/app/build/outputs/apk/debug" ]; then
            for apk in android/app/build/outputs/apk/debug/app-*.apk; do
              if [ -f "$apk" ]; then
                arch=$(basename "$apk" | sed 's/app-//' | sed 's/-debug.apk//')
                new_name="Nuvio-TV-${VERSION}-${arch}-debug.apk"
                mv "$apk" "android/app/build/outputs/apk/debug/${new_name}"
                echo "โ Renamed to: ${new_name}"
              fi
            done
          fi

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 13: UPLOAD RELEASE APKs
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ค Upload Release APKs
        if: |
          always() &&
          (steps.build-release.outcome == 'success')
        uses: actions/upload-artifact@v4
        with:
          name: Nuvio-TV-Release-v${{ steps.get-version.outputs.version }}
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: error

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 14: UPLOAD DEBUG APKs
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ค Upload Debug APKs
        if: |
          always() &&
          (steps.build-debug.outcome == 'success')
        uses: actions/upload-artifact@v4
        with:
          name: Nuvio-TV-Debug-v${{ steps.get-version.outputs.version }}
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: error

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 15: CREATE GITHUB RELEASE (ON TAG)
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ๐บ Nuvio Streaming - Android TV v${{ steps.get-version.outputs.version }}
            
            ### โจ Features
            - ๐ฎ Full D-pad & Remote Control Support
            - ๐บ Android TV Leanback Launcher Integration
            - ๐ Visual Focus Navigation
            - ๐ฌ Optimized for TV Viewing
            - ๐ฑ Works on Phones, Tablets, and TVs
            
            ### ๐ฆ Installation
            1. Download APK for your device architecture
            2. Enable "Unknown Sources" in TV Settings
            3. Install using File Manager
            
            ### ๐๏ธ Architecture Support
            - `arm64-v8a` - Modern Android TV (Recommended)
            - `armeabi-v7a` - Older Android TV Devices
            - `x86_64` - Android TV Emulators
            - `universal` - All Devices (Larger Size)
            
            ### ๐ง Technical Details
            - Android Version: 5.0+ (API 21+)
            - TV Version: Android TV 5.0+
            - Build Type: Release (Signed)
            - Node: ${{ env.NODE_VERSION }}
            - Java: ${{ env.JAVA_VERSION }}

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 16: BUILD STATUS
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ Set build status
        id: build-status
        if: always()
        run: |
          if [ "${{ steps.build-release.outcome }}" == "success" ] || [ "${{ steps.build-debug.outcome }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "โ Build completed successfully!"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "โ Build failed!"
          fi

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 17: CLEANUP (ALWAYS RUNS - PRESERVES APKs)
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐งน Cleanup (Preserve APKs)
        if: always()
        run: |
          echo "=== ๐งน Starting Cleanup ==="
          echo "โ๏ธ  APKs will be preserved!"
          
          # Clean Gradle caches
          echo "Cleaning Gradle caches..."
          rm -rf ~/.gradle/caches || true
          rm -rf ~/.gradle/wrapper || true
          
          # Clean build intermediates (NOT outputs!)
          echo "Cleaning build intermediates..."
          rm -rf android/app/build/intermediates || true
          rm -rf android/app/build/generated || true
          rm -rf android/app/build/tmp || true
          rm -rf android/.gradle || true
          
          # Clean npm cache
          echo "Cleaning npm cache..."
          rm -rf ~/.npm || true
          rm -rf node_modules || true
          
          # Clean system caches
          echo "Cleaning system caches..."
          sudo apt-get clean || true
          docker system prune -af || true
          sudo rm -rf /tmp/npm-* /tmp/yarn-* || true
          
          echo ""
          echo "=== โ APKs Preserved ==="
          ls -lh android/app/build/outputs/apk/*/*.apk 2>/dev/null || echo "No APKs found"
          
          echo ""
          echo "=== ๐ฝ Final Disk Space ==="
          df -h
        continue-on-error: true

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # STEP 18: BUILD SUMMARY
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: ๐ Build Summary
        if: always()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "                    BUILD SUMMARY                            "
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ Version: ${{ steps.get-version.outputs.version }}"
          echo "๐จ Build Type: ${{ github.event.inputs.build_type || 'release' }}"
          echo "โ Release: ${{ steps.build-release.outcome || 'skipped' }}"
          echo "โ Debug: ${{ steps.build-debug.outcome || 'skipped' }}"
          echo "๐ฏ Status: ${{ steps.build-status.outputs.success == 'true' && 'SUCCESS' || 'FAILED' }}"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
